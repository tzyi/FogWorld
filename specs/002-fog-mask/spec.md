# 功能規格說明：迷霧遮罩渲染與探索

**功能分支**：`002-fog-mask`
**建立日期**：2026-02-13
**狀態**：草稿
**輸入說明**：請參考 ref_specify.md

## 使用者情境與測試（必填）

> 所有 User Story 必須可獨立測試，且設計、驗收、開發皆需符合 FogWorld 憲法（技術核心、樣式、Android 最佳化、檔案結構、代碼品質、功能模組、治理條款等）之原則。

### User Story 1 - 啟動探索模式並顯示迷霧遮罩 (Priority: P1)

使用者進入主地圖頁後，按下「開始探索」按鈕，地圖上出現半透明迷霧遮罩，並以藍點為中心開啟透明區域，隨使用者移動即時更新。

**Why this priority**: 迷霧遮罩是探索功能的核心，直接影響用戶體驗與遊戲主題。

**Independent Test**: 按下「開始探索」後，迷霧遮罩正確顯示，透明區域隨藍點移動即時更新，渲染延遲小於 100ms，互動維持 60fps 以上。

**Acceptance Scenarios**:
1. **Given** 使用者進入主地圖頁，**When** 按下「開始探索」，**Then** 地圖顯示迷霧遮罩並開啟透明區域。
2. **Given** 已啟動探索模式，**When** 使用者移動，**Then** 透明區域隨藍點即時更新，渲染延遲 <100ms。

---

### User Story 2 - 擦除迷霧並記錄探索軌跡 (Priority: P2)

使用者移動時，經過座標點會擦除對應網格的遮罩，並每 5-10 秒自動儲存座標與軌跡，探索區域持續擴大。

**Why this priority**: 擦除迷霧與軌跡記錄是遊戲進度與成就的基礎。

**Independent Test**: 使用者移動時，迷霧遮罩被擦除，資料庫記錄軌跡與探索狀態，查詢延遲小於 50ms。

**Acceptance Scenarios**:
1. **Given** 使用者移動，**When** 經過新網格，**Then** 該網格遮罩被擦除並記錄軌跡，查詢延遲 <50ms。
2. **Given** 持續探索，**When** 每 5-10 秒，**Then** 自動儲存座標與軌跡，資料正確無遺漏。

---

### User Story 3 - 顯示統計資訊與異常處理 (Priority: P3)

系統即時計算已探索面積百分比、領土等級，並於狀態欄顯示。若定位失敗或未授權，迷霧遮罩全覆蓋地圖並彈出提示。

**Why this priority**: 統計資訊與異常處理提升用戶參與度與系統穩定性。

**Independent Test**: 統計資訊即時更新，定位失敗時顯示全覆蓋遮罩與提示，異常處理 100% 覆蓋。

**Acceptance Scenarios**:
1. **Given** 使用者探索，**When** 資料庫更新，**Then** 狀態欄即時顯示統計資訊。
2. **Given** 定位失敗或未授權，**When** 進入地圖，**Then** 顯示全覆蓋遮罩與提示訊息。

---

### Edge Cases

- 定位失敗或用戶未授權時，迷霧遮罩全覆蓋地圖，藍點不顯示，彈出提示，100% 覆蓋。
- 地圖資料載入失敗時，顯示錯誤提示並禁止探索功能，100% 覆蓋。
- 使用者快速移動或縮放地圖時，迷霧遮罩與透明區域需即時更新且不卡頓，渲染延遲 <100ms。
- 經緯度資料異常（超出範圍）時，軌跡不記錄且顯示警告，100% 覆蓋。

## Requirements（必填）

### Functional Requirements

- **FR-001**：系統必須在地圖上渲染半透明迷霧遮罩，並以藍點為中心開啟透明區域。
- **FR-002**：使用者按下「開始探索」後，迷霧遮罩才開始顯示，按鈕可切換遮罩顯示與否。
- **FR-003**：使用者移動時，系統必須擦除對應網格的遮罩，並每 5-10 秒自動儲存座標與軌跡。
- **FR-004**：地圖縮放時僅加載可視範圍內的迷霧遮罩，提升效能（渲染延遲 <100ms，互動 60fps 以上）。
- **FR-005**：系統必須即時計算並顯示已探索面積百分比與領土等級。
- **FR-006**：定位失敗或未授權時，迷霧遮罩全覆蓋地圖，藍點不顯示，並彈出提示訊息。
- **FR-007**：地圖資料載入失敗時，顯示錯誤提示並禁止探索功能，100% 覆蓋。
- **FR-008**：經緯度需正確轉換為地圖座標系，確保遮罩與透明區域精確對應地圖位置。
- **FR-009**：資料存取與查詢需優化經緯度查詢速度，查詢延遲 <50ms。
- **FR-010**：系統必須考慮跨平台（Android/iOS）相容性與效能，95% 以上裝置不卡頓或顯示異常。

### Key Entities

- **Grid**：全球地圖網格，屬性包含 grid_id（唯一）、explored（狀態）、updated_at（時間）。
- **Track**：使用者探索軌跡，屬性包含 id、time、lat、lng、grid_id。
- **Stat**：統計資訊，屬性包含 id、key（唯一）、value。

## Success Criteria（必填）

### Measurable Outcomes

- **SC-001**：使用者按下「開始探索」後，90% 以上可在 1 秒內看到迷霧遮罩與透明區域，渲染延遲 <100ms。
- **SC-002**：使用者移動時，95% 以上迷霧遮罩擦除與透明區域即時更新，無明顯卡頓，查詢延遲 <50ms。
- **SC-003**：系統每 5-10 秒自動儲存軌跡，資料庫記錄正確無遺漏。
- **SC-004**：統計資訊於狀態欄即時顯示，90% 以上用戶能正確看到探索面積與等級。
- **SC-005**：定位失敗或未授權時，100% 顯示全覆蓋遮罩與提示訊息。
- **SC-006**：地圖資料載入失敗時，100% 顯示錯誤提示並禁止探索功能。
- **SC-007**：經緯度查詢延遲 <50ms，跨平台（Android/iOS）95% 以上裝置不卡頓。

### 前提假設

- 使用者裝置支援 Canvas 技術。
- 地圖資料與定位服務可正常取得。
- 資料庫（如 SQLite）已正確設置並可用於查詢。
- 經緯度轉換與網格劃分邏輯已標準化。
